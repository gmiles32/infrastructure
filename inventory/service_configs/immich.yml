compose_schema_version: "3.8"
containers:
  - service_name: immich-server
    active: true
    container_name: immich-server
    image: ghcr.io/immich-app/immich-server:v1.81.1
    command: [ "start.sh", "immich" ]
    user: 1000:1000
    volumes:
      - photos:/usr/src/app/upload
    # env_file:
    #   - .env
    environment:
      - "DB_HOSTNAME=postgres"
      - "DB_USERNAME=immich"
      - "DB_DATABASE_NAME=immich"
      - "DB_PASSWORD={{ immich_pg_password }}"
      - "REDIS_HOSTNAME=immich-redis"
      - "TYPESENSE_ENABLED=false"
      - "DISABLE_REVERSE_GEOCODING=true"
      - "REVERSE_GEOCODING_PRECISION=0"
      - "IMMICH_WEB_URL=http://immich-web:3000"
      - "IMMICH_SERVER_URL=http://immich-server:3001"
      - "IMMICH_MACHINE_LEARNING_URL=false"
    depends_on:
      - name: redis
    restart: unless-stopped
    networks:
      - backend
      - default
  - service_name: immich-microservices
    active: true
    container_name: immich-microservices
    image: ghcr.io/immich-app/immich-server:v1.81.1
    command:  [ "start.sh", "immich" ]
    user: 1000:1000
    volumes:
      - photos:/usr/src/app/upload
    # env_file:
    #   - .env
    environment:
      - "DB_HOSTNAME=postgres"
      - "DB_USERNAME=immich"
      - "DB_DATABASE_NAME=immich"
      - "DB_PASSWORD={{ immich_pg_password }}"
      - "REDIS_HOSTNAME=immich-redis"
      - "TYPESENSE_ENABLED=false"
      - "DISABLE_REVERSE_GEOCODING=true"
      - "REVERSE_GEOCODING_PRECISION=0"
      - "IMMICH_WEB_URL=http://immich-web:3000"
      - "IMMICH_SERVER_URL=http://immich-server:3001"
      - "IMMICH_MACHINE_LEARNING_URL=false"
    depends_on:
      - name: redis
    restart: unless-stopped
    networks:
      - backend
      - default

  - service_name: immich-web
    active: true
    container_name: immich-web
    image: ghcr.io/immich-app/immich-web:v1.81.1
    user: 1000:1000
    # env_file:
    #   - .env
    environment:
      - "DB_HOSTNAME=postgres"
      - "DB_USERNAME=immich"
      - "DB_DATABASE_NAME=immich"
      - "DB_PASSWORD={{ immich_pg_password }}"
      - "REDIS_HOSTNAME=immich-redis"
      - "TYPESENSE_ENABLED=false"
      - "DISABLE_REVERSE_GEOCODING=true"
      - "REVERSE_GEOCODING_PRECISION=0"
      - "IMMICH_WEB_URL=http://immich-web:3000"
      - "IMMICH_SERVER_URL=http://immich-server:3001"
      - "IMMICH_MACHINE_LEARNING_URL=false"
    restart: unless-stopped
    networks:
      - default

  - service_name: redis
    active: true
    container_name: immich-redis
    image: redis:7.2-alpine@sha256:343e6546f35877801de0b8580274a5e3a8e8464cabe545a2dd9f3c78df77542a
    restart: unless-stopped
    networks:
      - default

  - service_name: immich-proxy
    active: true
    container_name: immich-proxy
    image: ghcr.io/immich-app/immich-proxy:v1.82.0
    environment:
      - "IMMICH_WEB_URL=http://immich-web:3000"
      - "IMMICH_SERVER_URL=http://immich-server:3001"
    depends_on:
      - name: immich-server
      - name: immich-web
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.immich.entrypoints=web"
      - "traefik.http.routers.immich.rule=Host(`immich.{{ domain }}`)"
      - "traefik.http.middlewares.immich-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.immich.middlewares=immich-https-redirect"
      - "traefik.http.routers.immich-secure.entrypoints=websecure"
      - "traefik.http.routers.immich-secure.rule=Host(`immich.{{ domain }}`)"
      - "traefik.http.routers.immich-secure.tls=true"
      - "traefik.http.routers.immich-secure.service=immich"
      - "traefik.http.services.immich.loadbalancer.server.port=8080"
      - "traefik.docker.network=frontend"
    networks:
      - frontend
      - default

networks:
  - network_name: frontend
    external: true
  - network_name: backend
    external: true
  - network_name: default

volumes:
  - volume_name: photos
    driver: local
    driver_opts:
      - name: type
        value: nfs
      - name: o
        value: nfsvers=4,addr={{ nas }},rw
      - name: device
        value: ":/mnt/proton/containers/immich"
